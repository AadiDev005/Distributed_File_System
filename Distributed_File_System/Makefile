.PHONY: api dashboard enterprise clean help install dev collab-test kill-ports status build test stop restart logs check-deps quick-start full-clean health-check api-safe dev-safe force-kill-ports nuclear-clean diagnose-ports

# üèÜ DataVault Enterprise - Development Commands
# ===============================================

help: ## Show this help message
	@echo "üèÜ DataVault Enterprise - Development Commands"
	@echo "=============================================="
	@echo "Phase 1.5: Collaboration Interface Implementation"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

api: ## Start Main Enterprise Server with WebSocket Collaboration (port 3000)
	@echo "üöÄ Starting DataVault Enterprise Server with Collaboration..."
	@echo "üìä Serving enterprise metrics and WebSocket collaboration"
	@echo "üèÜ DataVault Enterprise - Dashboard API Service"
	@echo "==============================================="
	@echo "üìä Phase 1.5: Collaboration Interface"
	@echo ""
	@echo "üöÄ API Server: http://localhost:3000"
	@echo "üéØ Next.js Dashboard: http://localhost:3001/dashboard"
	@echo "üìà Metrics: 40% efficiency, 60% security, 35% performance"
	@echo "üõ°Ô∏è Security: All 11 enterprise layers active"
	@echo "üìã Compliance: 100% audit compliance"
	@echo ""
	@echo "‚úÖ All API endpoints ready for dashboard integration!"
	@go run main.go server.go auth.go collaboration_fix.go operational_transform_engine.go workflow_management_engine.go policy_recommendation_engine.go immutable_audit_trail.go gdpr_compliance_automation.go pii_detection_compliance.go continuous_authentication.go attribute_based_encryption.go threshold_secret_sharing.go zero_trust_advanced.go bft.go enterprise_crypto.go compliance_engine.go audit.go store.go crypto.go

dashboard: ## Start Next.js Executive Dashboard (port 3001)
	@echo "üìä Starting DataVault Executive Dashboard..."
	@echo "üéØ Navigate to: http://localhost:3001/dashboard"
	@cd datavault-dashboard && npm run dev

enterprise: ## Start Enterprise P2P Server (same as api)
	@echo "üèóÔ∏è  Starting DataVault Enterprise Server..."
	@echo "üõ°Ô∏è All 11 security layers will be initialized"
	@$(MAKE) api

dev: ## Start Enterprise Server + Dashboard together
	@echo "üöÄ Starting DataVault Enterprise Development Environment..."
	@echo "‚ö° API Server will start on: http://localhost:3000"
	@echo "üìä Dashboard will start on: http://localhost:3001/dashboard"
	@echo "üßπ Ensuring ports are clear first..."
	@$(MAKE) kill-ports-enhanced
	@sleep 3
	@$(MAKE) api & \
	sleep 5 && \
	$(MAKE) dashboard

collab-test: ## Test WebSocket collaboration endpoint
	@echo "üîç Testing WebSocket collaboration..."
	@curl -i -N \
		-H "Connection: Upgrade" \
		-H "Upgrade: websocket" \
		-H "Sec-WebSocket-Version: 13" \
		-H "Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==" \
		-H "X-Session-ID: test-session" \
		"http://localhost:3000/ws/collaboration"

kill-ports: ## Kill processes on ports used by DataVault (standard method)
	@echo "üî• Killing processes on DataVault ports (standard method)..."
	@echo "Trying graceful termination first..."
	@-lsof -ti:3000 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:4000 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:5000 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:5001 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:3001 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:8080 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:8081 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:8082 | xargs kill -15 2>/dev/null || true
	@sleep 2
	@echo "Force killing remaining processes..."
	@-lsof -ti:3000 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:4000 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:5000 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:5001 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:3001 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:8080 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:8081 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:8082 | xargs kill -9 2>/dev/null || true
	@echo "‚úÖ Standard port clearing complete!"

kill-ports-enhanced: ## Enhanced port killing with sudo for system services
	@echo "üî• Enhanced port clearing (handles system services)..."
	@echo "Checking what's using critical ports..."
	@-lsof -i :5000 2>/dev/null && echo "‚ö†Ô∏è  Port 5000 in use - will attempt sudo kill" || echo "‚úÖ Port 5000 free"
	@echo "Step 1: Graceful termination..."
	@-lsof -ti:3000 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:4000 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:5000 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:5001 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:3001 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:8080 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:8081 | xargs kill -15 2>/dev/null || true
	@-lsof -ti:8082 | xargs kill -15 2>/dev/null || true
	@sleep 2
	@echo "Step 2: Force killing user processes..."
	@-lsof -ti:3000 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:4000 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:5000 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:5001 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:3001 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:8080 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:8081 | xargs kill -9 2>/dev/null || true
	@-lsof -ti:8082 | xargs kill -9 2>/dev/null || true
	@sleep 1
	@echo "Step 3: Handling system services (requires sudo)..."
	@if lsof -i :5000 >/dev/null 2>&1; then \
		echo "üîí Port 5000 still in use (likely AirPlay), trying sudo kill..."; \
		sudo lsof -ti:5000 | xargs sudo kill -9 2>/dev/null || echo "‚ùå Could not kill process on 5000 - check System Preferences > Sharing"; \
	else \
		echo "‚úÖ Port 5000 is now free"; \
	fi
	@echo "‚úÖ Enhanced port clearing complete!"

force-kill-ports: ## Force kill ALL processes on ports (including system services)
	@echo "üíÄ FORCE killing ALL processes on DataVault ports..."
	@echo "‚ö†Ô∏è  This will kill system services like AirPlay if they use these ports!"
	@echo "Attempting sudo kill for all ports..."
	@-sudo lsof -ti:3000 | xargs sudo kill -9 2>/dev/null || true
	@-sudo lsof -ti:4000 | xargs sudo kill -9 2>/dev/null || true
	@-sudo lsof -ti:5000 | xargs sudo kill -9 2>/dev/null || true
	@-sudo lsof -ti:5001 | xargs sudo kill -9 2>/dev/null || true
	@-sudo lsof -ti:3001 | xargs sudo kill -9 2>/dev/null || true
	@-sudo lsof -ti:8080 | xargs sudo kill -9 2>/dev/null || true
	@-sudo lsof -ti:8081 | xargs sudo kill -9 2>/dev/null || true
	@-sudo lsof -ti:8082 | xargs sudo kill -9 2>/dev/null || true
	@echo "üíÄ FORCE port clearing complete!"
	@echo "üìù Note: If AirPlay was using port 5000, disable it in System Preferences > Sharing"

status: ## Check what's running on ports
	@echo "üîç Checking DataVault port status..."
	@echo "Port 3000 (P2P Node 1):"
	@lsof -i :3000 2>/dev/null || echo "  ‚úÖ Available"
	@echo "Port 4000 (P2P Node 2):"
	@lsof -i :4000 2>/dev/null || echo "  ‚úÖ Available"
	@echo "Port 5000 (P2P Node 3):"
	@lsof -i :5000 2>/dev/null || echo "  ‚úÖ Available"
	@echo "Port 5001 (P2P Node 3 Alt):"
	@lsof -i :5001 2>/dev/null || echo "  ‚úÖ Available"
	@echo "Port 8080 (API Node 1):"
	@lsof -i :8080 2>/dev/null || echo "  ‚úÖ Available"
	@echo "Port 8081 (API Node 2):"
	@lsof -i :8081 2>/dev/null || echo "  ‚úÖ Available"
	@echo "Port 8082 (API Node 3):"
	@lsof -i :8082 2>/dev/null || echo "  ‚úÖ Available"
	@echo "Port 3001 (Dashboard):"
	@lsof -i :3001 2>/dev/null || echo "  ‚úÖ Available"

install: ## Install frontend dependencies
	@echo "üì¶ Installing frontend dependencies..."
	@cd datavault-dashboard && npm install --legacy-peer-deps

build: ## Build the entire project
	@echo "üèóÔ∏è  Building DataVault Enterprise..."
	@go build -o datavault-server main.go server.go auth.go collaboration_fix.go operational_transform_engine.go workflow_management_engine.go policy_recommendation_engine.go immutable_audit_trail.go gdpr_compliance_automation.go pii_detection_compliance.go continuous_authentication.go attribute_based_encryption.go threshold_secret_sharing.go zero_trust_advanced.go bft.go enterprise_crypto.go compliance_engine.go audit.go store.go crypto.go
	@cd datavault-dashboard && npm run build

test: ## Run tests
	@echo "üß™ Running DataVault Enterprise tests..."
	@go test -v ./...
	@echo "üß™ Running frontend tests..."
	@cd datavault-dashboard && npm test

clean: ## Clean all build artifacts
	@echo "üßπ Cleaning DataVault Enterprise build artifacts..."
	@go clean
	@rm -f datavault-server
	@cd datavault-dashboard && rm -rf .next node_modules/.cache dist
	@echo "‚úÖ Cleanup complete!"

# üöÄ Enhanced Commands for DataVault Enterprise
stop: ## Stop all running DataVault processes
	@echo "üõë Stopping all DataVault processes..."
	@$(MAKE) kill-ports-enhanced
	@-pkill -f "datavault-server" 2>/dev/null || true
	@-pkill -f "npm run dev" 2>/dev/null || true
	@-pkill -f "go run" 2>/dev/null || true
	@echo "‚úÖ All DataVault processes stopped!"

restart: ## Restart the entire development environment
	@echo "üîÑ Restarting DataVault Enterprise..."
	@$(MAKE) stop
	@sleep 3
	@$(MAKE) dev

logs: ## Show logs from running processes
	@echo "üìã DataVault Enterprise Logs:"
	@echo "============================="
	@ps aux | grep -E "(datavault|npm run dev|go run)" | grep -v grep || echo "No DataVault processes running"

check-deps: ## Check if all dependencies are installed
	@echo "üîç Checking DataVault Enterprise Dependencies..."
	@command -v go >/dev/null 2>&1 || { echo "‚ùå Go is not installed"; exit 1; }
	@command -v node >/dev/null 2>&1 || { echo "‚ùå Node.js is not installed"; exit 1; }
	@command -v npm >/dev/null 2>&1 || { echo "‚ùå npm is not installed"; exit 1; }
	@test -d datavault-dashboard/node_modules || { echo "‚ùå Frontend dependencies not installed. Run 'make install'"; exit 1; }
	@echo "‚úÖ All dependencies are installed!"

# Additional useful commands
quick-start: check-deps ## Quick start after checking dependencies
	@echo "üöÄ Quick starting DataVault Enterprise..."
	@$(MAKE) dev

full-clean: ## Complete cleanup including node_modules
	@echo "üßπ Performing full cleanup..."
	@$(MAKE) clean
	@cd datavault-dashboard && rm -rf node_modules package-lock.json
	@echo "‚úÖ Full cleanup complete! Run 'make install' to reinstall dependencies."

health-check: ## Check if all services are running properly
	@echo "üè• DataVault Enterprise Health Check..."
	@echo "Checking API endpoints..."
	@curl -s --max-time 5 http://localhost:8080/health >/dev/null 2>&1 && echo "‚úÖ Node 1 API: Healthy" || echo "‚ùå Node 1 API: Down"
	@curl -s --max-time 5 http://localhost:8081/health >/dev/null 2>&1 && echo "‚úÖ Node 2 API: Healthy" || echo "‚ùå Node 2 API: Down"
	@curl -s --max-time 5 http://localhost:8082/health >/dev/null 2>&1 && echo "‚úÖ Node 3 API: Healthy" || echo "‚ùå Node 3 API: Down"
	@curl -s --max-time 5 http://localhost:3001 >/dev/null 2>&1 && echo "‚úÖ Dashboard: Healthy" || echo "‚ùå Dashboard: Down"

# Alternative API start with automatic test file exclusion
api-safe: ## Start API server excluding test files automatically
	@echo "üöÄ Starting DataVault Enterprise Server (Safe Mode)..."
	@echo "üìä Automatically excluding test files..."
	@go run $$(ls *.go | grep -v '_test.go')

# Development with safe mode
dev-safe: ## Start development environment with safe API mode
	@echo "üöÄ Starting DataVault Enterprise Development Environment (Safe Mode)..."
	@echo "‚ö° API Server will start on: http://localhost:3000 (Safe Mode)"
	@echo "üìä Dashboard will start on: http://localhost:3001/dashboard"
	@echo "üßπ Ensuring ports are clear first..."
	@$(MAKE) kill-ports-enhanced
	@sleep 3
	@$(MAKE) api-safe & \
	sleep 5 && \
	$(MAKE) dashboard

# Nuclear option for when ports are completely stuck
nuclear-clean: ## Nuclear option - kill everything and clean all ports
	@echo "‚ò¢Ô∏è  NUCLEAR CLEAN - Killing ALL DataVault related processes..."
	@echo "This will terminate everything forcefully!"
	@$(MAKE) force-kill-ports
	@-pkill -f "go run" 2>/dev/null || true
	@-pkill -f "npm run dev" 2>/dev/null || true
	@-pkill -f "datavault" 2>/dev/null || true
	@-pkill -f "node.*3001" 2>/dev/null || true
	@-sudo pkill -f "ControlCenter" 2>/dev/null || echo "AirPlay not running"
	@sleep 3
	@echo "‚ò¢Ô∏è  Nuclear cleanup complete! All ports should be clear now."
	@$(MAKE) status

# Quick diagnosis for port conflicts
diagnose-ports: ## Diagnose what's using DataVault ports
	@echo "üî¨ Diagnosing DataVault port usage..."
	@echo ""
	@for port in 3000 4000 5000 5001 3001 8080 8081 8082; do \
		echo "=== Port $$port ==="; \
		if lsof -i :$$port 2>/dev/null; then \
			echo "Process details:"; \
			lsof -i :$$port 2>/dev/null | awk 'NR>1 {print "  PID: " $$2 ", Command: " $$1 ", User: " $$3}'; \
		else \
			echo "‚úÖ Port $$port is free"; \
		fi; \
		echo ""; \
	done
	@echo "üîç Common issues:"
	@echo "   - Port 5000: Usually macOS AirPlay Receiver (ControlCenter process)"
	@echo "   - Port 3000: May conflict with other development servers"
	@echo "   - If you see 'ControlCenter' or 'AirPlay', disable in System Preferences > Sharing"

# Fix for persistent AirPlay issues
fix-airplay: ## Specifically handle AirPlay Receiver on port 5000
	@echo "üîß Fixing AirPlay Receiver on port 5000..."
	@echo "Checking if AirPlay is using port 5000..."
	@if lsof -i :5000 2>/dev/null | grep -q "ControlCenter\|AirPlay"; then \
		echo "‚ö†Ô∏è  AirPlay Receiver found on port 5000"; \
		echo "Attempting to kill AirPlay processes..."; \
		sudo pkill -f "ControlCenter" 2>/dev/null || true; \
		sleep 2; \
		if lsof -i :5000 >/dev/null 2>&1; then \
			echo "‚ùå AirPlay still running. You need to disable it manually:"; \
			echo "   1. Open System Preferences/Settings"; \
			echo "   2. Go to Sharing"; \
			echo "   3. Uncheck 'AirPlay Receiver'"; \
			echo "   4. Or change its port to something other than 5000"; \
		else \
			echo "‚úÖ Port 5000 is now free!"; \
		fi; \
	else \
		echo "‚úÖ Port 5000 is free or not used by AirPlay"; \
	fi

.DEFAULT_GOAL := help
